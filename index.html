<html>
  <head>
    <title>Soundboard Webinterface</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="http://localhost:8080/socket.io/socket.io.js"></script>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/util.min.js"></script>
    <script src="assets/js/filelist.js"></script>
    <script>
      var socket;
      var config;
      var tracks;
      var suffle = false;
      var repeat = false;
      $(document).ready(function onDocumentReady() {
        socket = io.connect("localhost:8080");
        var runtime = new (function(socket, undefined) {
          this.log = function(string) {
            socket.emit("log", { 'log': window.util.format(string) });
            console.log(string);
          };
          this.loading = {};
          this.extra = {};
        })(socket);
        function checkLoading() {
          loading = false;
          for (var k in runtime.loading) {
            if (runtime.loading.hasOwnProperty(k)) {
              if (runtime.loading[k] === true) {
                loading = true;
                break;
              }
            }
          }
          $('#refresh').find(".fa")[loading ? 'addClass' : 'removeClass']('fa-spin');
          $('#refresh')[loading ? 'addClass' : 'removeClass']('active');
        }
        function setLoading(item, state) {
          runtime.loading[item] = state;
          checkLoading();
        }
        socket.on('get_config', function getConfig(remoteconfig) {
          config = remoteconfig;
          socket.emit("update");
        });
        socket.on('isPlaying', function onIsPlaying(data) {
          setLoading("getIsPlaying", true);
          $('#play')[data["playing"] ? 'addClass' : 'removeClass']('playing');
          $('#play').find(".fa")[data["playing"] ? 'addClass' : 'removeClass']('fa-pause');
          $('#play').find(".fa")[!data["playing"] ? 'addClass' : 'removeClass']('fa-play');
          setLoading("getIsPlaying", false);
        });
        socket.on('get_queue',function onGetCurrentQueue(data){
          runtime.log(data);
          setLoading("getQueue", true);
          $('#shuffle').children()[data["shuffle"] ? 'addClass' : 'removeClass']('active');
          $('#repeat').children()[data["repeat"] > 0 ? 'addClass' : 'removeClass']('active');
          $('#repeat').children()[data["repeat"] == 2 ? 'addClass' : 'removeClass']('single');
          tracks = data["queue"];
          $('.queue').empty();
          $('#queue_count').text(tracks.length + " track" + (tracks.length > 1 ? "s" : "") + " in queue");
          tracks.forEach(function(track, index){
            var elem = $('<li></li>');
            elem.addClass('item');
            elem[(!!data["currentTrack"] && !!data["currentTrack"]["id"] && track["id"] == data["currentTrack"]["id"]) ? 'addClass' : 'removeClass']('current');
            elem.attr('data-index', index);
            elem.attr('data-id', track["id"]);
            var title = $('<div></div>');
            title.attr('data-service', track["service"]);
            title.attr('data-path', track["path"]);
            title.addClass('track');
            title.addClass('title');
            if (config["services"] && config["services"][track["service"]] && config["services"][track["service"]]["icon"]) {
              var icon = $('<i></i>');
              icon.addClass("fa");
              icon.addClass("fa-" + config["services"][track["service"]]["icon"]);
              title.append(icon);
            }
            title.html(title.html() + ' ' + track["path"] + '<span class="extra"></span>');
            elem.append(title);
            elem.append(generate_controls());
            elem.append($('<div class="clearfix"></div>'));
            $('.queue').append(elem);
          });
          $('.queue').find('a').on('click', function() {
            var e = $(this);
            var a = e.attr('data-action');
            var i = e.closest('.item');
            var id = i.attr('data-id');
            var index = i.attr('data-index');
            //alert(a + '\n' + index + '\n' + id + '\n');
            if(a == "play"){
              onPlaySelectedTrack(id);
            } else if (a == "up") {
              onMoveTrack(id,parseInt(index)-1);
            } else if (a == "down") {
              onMoveTrack(id,parseInt(index)+1);
            } else if (a == "remove"){
              onRemoveTrack(id);
            } else {
              runtime.log("What do you want from me?");
            }
          });
          if (!!data["currentTrack"] && !!data["currentTrack"]["path"]) {
            $('#tracktitle').text((getExtra(data["currentTrack"]["service"], data["currentTrack"]["path"]) === "") ? data["currentTrack"]["path"] : getExtra(data["currentTrack"]["service"], data["currentTrack"]["path"]));
          }
          updateExtras();
          setLoading("getQueue", false);
        });
        socket.on('poll', function onPoll() {
          runtime.log("poll");
          socket.emit("isPlaying");
          socket.emit("get_queue");
          socket.emit("getFiles");
          socket.emit("get_playlist", {"name": undefined});
        });
        socket.on('getFiles', function onGetFiles(data) {
          runtime.log("filelist");
          setLoading("getFiles", true);
          //runtime.log(data);
          generate_filelist($($('.files li')[0]), data["files"]);
          $($('.files li')[0]).find("ul").each(function() {
            $(this).children().last().addClass("lastChild");
          });
          $('.tabcontrol .tab#filesystem .fm .files .collapse').each(function() {
            CollapsibleLists.applyTo(this);
          });
          $('.files li').find('a').on('click', function() {
            var e = $(this);
            var path = e.attr('data-path');
            $('#filesystem-path').val(path);
          });
          setLoading("getFiles", false);
        });
        function generate_filelist(parent, data, title) {
          ulclass = "";
          if (title === undefined) {
            title = "Files";
            ulclass = "collapse";
          }
          //runtime.log(title);
          parent.empty();
          if (typeof data === "object") {
            parent.append($('<i>' + title + '</i>'));
            if (!isEmpty(data)) {
              var ul = $('<ul></ul>');
              if (ulclass != "") {
                ul.addClass(ulclass);
              }
              for (var k in data) {
                if (data.hasOwnProperty(k)) {
                    var childs = $('<li></li>');
                    generate_filelist(childs, data[k], k);
                    ul.append(childs);
                }
              }
              parent.append(ul);
            }
          } else {
            //runtime.log(title + " => " + data);
            parent.append($('<a data-path="' + data + '" href="#">' + title + '</a>'));
          }
        }
        socket.on('get_playlist', function onGetPlaylist(data){
          runtime.log('playlists');
          runtime.log(data);
          setLoading("getPlaylist", true);
          $('.playlists').empty();
          if(data['playlists'].length == 0){
            var elem = $('<li></li>');
            elem.addClass('item');
            elem.html('No Playlists');
            $('.playlists').append(elem);
          } else {
            var playlists = data['playlists'];
            //runtime.log(playlists);
            playlists.forEach(function(playlist, index){
              var elem = $('<li></li>');
              elem.addClass('item');
              elem.attr('data-index', index);
              elem.attr('data-id', playlist);
              var title = $('<div></div>');
              title.addClass('title');
              title.html(playlist);
              elem.append(title);
              elem.append(generate_playlist_controls());
              elem.append($('<div class="clearfix"></div>'));
              $('.playlists').append(elem);
            });
            $('.playlists').find('a').on('click', function() {
              var e = $(this);
              var a = e.attr('data-action');
              var i = e.closest('.item');
              var id = i.attr('data-id');
              var index = i.attr('data-index');
              //alert(a + '\n' + index + '\n' + id + '\n');
              if(a == "play"){
                onLoadPlaylist(id);
              } else if (a == "info"){
                onPlaylistInfo(id);
              } else if (a == "save"){
                onSavePlaylist(id);
              } else if (a == "delete"){
                onDeletePlaylist(id);
              } else {
                runtime.log("What do you want from me?");
              }
            });
          }
          setLoading("getPlaylist", false);
        });
        socket.on('get_playlist_tracks', function onGetPlaylist(data){
          if (!!data["tracks"]) {
            tracks = data["tracks"];
            list = $('<ul></ul>');
            tracks.forEach(function (track, i) {
              runtime.log(track);
              var elem = $('<li></li>');
              elem.attr('data-service', track["service"]);
              elem.attr('data-path', track["path"]);
              elem.addClass('track');
              elem.addClass('item');
              if (config["services"] && config["services"][track["service"]] && config["services"][track["service"]]["icon"]) {
                var icon = $('<i></i>');
                icon.addClass("fa");
                icon.addClass("fa-" + config["services"][track["service"]]["icon"]);
                elem.append(icon);
              }
              elem.html(elem.html() + ' ' + track["path"] + '<span class="extra"></span>');
              list.append(elem);
            });
            $('#playlistinfo .content').empty();
            $('#playlistinfo .content').append(list);
            $('#playlistinfo .title').text(data["playlist"]);
            $('#playlistinfo').addClass("show");
            updateExtras();
          }
        });
        function generate_controls() {
          var controls = $('<div></div>');
          controls.addClass('pbc');
          controls.append(generate_action('play', 'play'));
          controls.append(generate_action('up', 'chevron-up'));
          controls.append(generate_action('down', 'chevron-down'));
          controls.append(generate_action('remove', 'remove'));
          return controls;
        }
        function generate_playlist_controls() {
          var controls = $('<div></div>');
          controls.addClass('pbc');
          controls.append(generate_action('play', 'play'));
          controls.append(generate_action('info', 'info'));
          controls.append(generate_action('save', 'download'));
          controls.append(generate_action('delete', 'trash'));
          return controls;
        }
        function generate_action(name, icon) {
          return $('<a data-action="' + name + '"><i class="fa fa-' + icon + '"></i></a>');
        }
        function emitPlayPause() {
          if ($('#play').hasClass('playing')) {
            emitPause();
          } else {
            emitPlay();
          }
        }
        function emitPause() {
          socket.emit('pause');
          socket.emit('isPlaying');
        }
        function emitPlay() {
          socket.emit('play');
          socket.emit('isPlaying');
        }
        function emitNext(){
          socket.emit('next', { "force": true });
        }
        function emitPrev() {
          socket.emit('prev', { "force": true });
        }
        function onPlayTitle(){
          //runtime.log("send track");
          service = $('#serviceSelector').attr("data-service");
          path = $('#' + service + '-path').val();
          socket.emit("add_track", {"service": service, "path": path,'next': true});
          clearInput();
        }
        function onAddToQueue() {
          service = $('#serviceSelector').attr("data-service");
          path = $('#' + service + '-path').val();
          socket.emit("add_track", {"service": service, "path": path + "",'next': false});
          clearInput();
        }
        function clearInput() {
          $('#serviceSelector .tab').each(function() {
            service = $(this).attr("data-service");
            if (!!service) {
              $('#' + service + '-path').val("");
            }
          });
        }
        function onClearQueue() {
          socket.emit("clear_queue");
        }
        function onStop() {
          socket.emit("stop");
        }
        function onLoadPlaylist(name) {
          socket.emit("playPlaylist", {'name': name, 'playing': true});
        }
        function onPlaylistInfo(name) {
          socket.emit("get_playlist", {"name": name});
        }
        function onSavePlaylist(name) {
          if (!name) {
            name = $('#playlistname_input').val();
          }
          if(name != ""){
              socket.emit("save_queue_to_playlist", {"playlistname": name});
              $('#playlistname_input').val("");
          } else {
            window.alert('You need to give the Playlist a name');
          }
        }
        function onDeletePlaylist(name) {
          socket.emit("delete_playlist", {'name': name});
        }
        function toggleShuffle() {
          socket.emit('toggleShuffle');
          socket.emit('get_queue');
        };
        function toggleRepeat() {
          socket.emit('toggleRepeat');
          socket.emit('get_queue');
        }
        function onPlaySelectedTrack(id) {
          socket.emit('playtrack',{'id':id});
        }
        function onRemoveTrack(id) {
          socket.emit("delete_track", {'id': id});
          socket.emit("get_queue");
        }
        function onMoveTrack(id, newpos) {
          socket.emit("chpos_of_track",{'id':id,'newpos':newpos});
          socket.emit("get_queue");
        }
        $('#refresh').on('click', function() {
          socket.emit("update");
        });

        $('#prev').on('click', emitPrev);
        $('#next').on('click', emitNext);

        $('#play').on('click', emitPlayPause);
        $('#play_track').on('click', onPlayTitle);
        $('#add_to_queue').on('click', onAddToQueue);
        $('#clear_queue').on('click', onClearQueue);
        $('#stop').on('click', onStop);
        $('#save_queue_to_playlist').on('click', function() { onSavePlaylist(); });
        $('#repeat').on('click', toggleRepeat);
        $('#shuffle').on('click', toggleShuffle);

        $('.modal .controls a').on('click', function() {
          $(this).closest('.modal').removeClass("show");
        });

        socket.emit('get_config');

        $('.tabcontrol').each(function() {
          tabcontrol = $(this);
          tabcontrol.bind('redraw', function() {
            if (!!$(this).attr("data-tab")) {
              $(this).find(".tab").removeClass("active");
              $(this).find(".tab#" + $(this).attr("data-tab")).addClass("active");
            } else {
              tabs = $(this).find(".tab");
              if (tabs.length) {
                $(this).trigger("setTab", [ $(tabs[0]).attr("id") ]);
              }
            }
            initializeJS();
          });
          tabcontrol.bind('setTab', function(event, id) {
            tab = $(this).find(".tab#" + id);
            $(this).find('.wrapper .nav a').removeClass("active");
            $(this).find('.wrapper .nav a[data-id="' + id + '"]').addClass("active");
            if (tab.length) {
              $(this).attr("data-tab", id);
              $(this).attr("data-service", tab.attr("data-service"));
              $(this).trigger("redraw");
            }
          });
          var nav = tabcontrol.find(".wrapper .nav");
          if (nav.length) {
            nav = $(nav[0]);
            tabcontrol.find(".tab").each(function() {
              tab = $(this);
              id = tab.attr("id");
              link = $('<a href="#" data-id="' + id + '"></a>');
              link.html(tab.find(".title").html());
              link.bind("click", { tabcontrol: tabcontrol }, function(event) {
                event.data.tabcontrol.trigger("setTab", [ $(this).attr("data-id") ]);
              });
              item = $('<li></li>');
              item.append(link);
              nav.append(item);
            });
            tabcontrol.trigger("setTab", [ (!!tabcontrol.attr("data-tab")) ? tabcontrol.attr("data-tab") : $(tabcontrol.find(".tab")[0]).attr("id") ]);
          }
        });
        function loadExtra(service, path) {
          extra = "";
          switch (service) {
            case "youtube":
              if (!config["services"] || !config["services"][service] || !config["services"][service]["apikey"]) {
                runtime.log("No api key for youtube configured");
                break;
              }
              $.ajax({
                async: false,
                method: "GET",
                url: "https://www.googleapis.com/youtube/v3/videos?part=snippet&key=" + config["services"][service]["apikey"] + "&id=" + path
              }).done(function(data) {
                if (!!data["items"] && data["items"].length > 0 && !!data["items"][0]["snippet"] && !!data["items"][0]["snippet"]["title"]) {
                  extra = data["items"][0]["snippet"]["title"];
                }
              });
              break;
            case "filesystem":
              split = path.split("/");
              extra = split[split.length - 1];
              break;
          }
          return extra;
        }
        function getExtra(service, path) {
          if (!runtime.extra[service]) {
            runtime.extra[service] = {};
          }
          if (!runtime.extra[service][path]) {
            runtime.extra[service][path] = loadExtra(service, path);
          }
          return runtime.extra[service][path];
        }
        function updateExtras() {
          $('.extra').each(function(i) {
            span = $(this);
            data = span.closest('.track');
            service = data.attr('data-service');
            path = data.attr('data-path');
            if (getExtra(service, path) != "") {
              span.text(getExtra(service, path));
              span.html(' <i class="fa fa-minus"></i> ' + span.html());
            }
          });
        }

        function initializeJS() {
          // Do nothing

        }

        function isEmpty(obj) {
          // null and undefined are "empty"
          if (obj == null) return true;
          // Assume if it has a length property with a non-zero value
          // that that property is correct.
          if (obj.length > 0)    return false;
          if (obj.length === 0)  return true;
          // Otherwise, does it have any properties of its own?
          // Note that this doesn't handle
          // toString and valueOf enumeration bugs in IE < 9
          for (var key in obj) {
            if (hasOwnProperty.call(obj, key)) return false;
          }
          return true;
        }
        $(window).bind('beforeunload', function(){
          return 'Leaving the page will wipe the cached data.\nIf you want to reload use the reload button on the page.\n\nDo u want to leave the page?';
        });
      });
    </script>
  </head>
  <body id="page">
    <div class="header">
      <h1>Soundboard Webinterface</h1>

    </div>
    <div class="content">
      <div id="playlistinfo" class="modal">
        <div class="wrapper">
          <div class="controls">
            <a href="#" class="close"></a>
          </div>
          <h3 class="title clearfix"></h3>
          <div class="content"></div>
        </div>
      </div>
      <div class="flex">
        <div class="container">
          <div class="title clearfix"><h3>Playlists</h3><a id="refresh" class="right biger"><i class="fa fa-refresh"></i></a></div>
          <div class="content">
            <div id="serviceSelector" class="tabcontrol">
              <div class="wrapper">
                <ul class="nav"></ul>
                <div class="tabs">
                  <div id="youtube" data-service="youtube" class="tab">
                    <div class="title"><i class="fa fa-youtube-play"></i> YouTube</div>
                    <div class="content">
                      <div class="pbc"><input type="text" id="youtube-path" name="youtube-path"/></div>
                    </div>
                  </div>
                  <div id="filesystem" data-service="filesystem" class="tab">
                    <div class="title"><i class="fa fa-folder"></i> Filesystem</div>
                    <div class="content">
                      <div class="pbc"><input type="text" id="filesystem-path" name="filesystem-path" readonly/></div>
                      <div class="fm">
                        <ul class="files"><li></li></ul>
                      </div>
                    </div>
                  </div>
                  <div id="url" data-service="url" class="tab">
                    <div class="title"><i class="fa fa-link"></i> URL</div>
                    <div class="content">
                      <div class="pbc"><input type="text" id="url-path" name="url-path"/></div>
                    </div>
                  </div>
                  <div id="soundcloud" data-service="soundcloud" class="tab">
                    <div class="title"><i class="fa fa-soundcloud"></i> SoundCloud</div>
                    <div class="content">
                      <div class="pbc"><input type="text" id="soundcloud-path" name="soundcloud-path"/></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="append">
            <div class="pbc"><a class="pbc" id="play_track" href="#"><i class="fa fa-play"></i><div> Play this track</div></a></div>
            <div class="pbc"><a id="add_to_queue" href="#"><i class="fa fa-plus"></i><div> Add to Queue</div></a></div>
            <div class="pbc"><a id="clear_queue" href="#"><i class="fa fa-eject"></i><div> Clear Queue</div></a></div>
          </div>
        </div>
        <div class="container">
          <div class="title clearfix"><h3>Current Queue</h3><div id="queue_count" class="right"></div></div>
          <div class="content">
            <ul class="queue list"></ul>
          </div>
          <div class="append">
            <div class="pbc"><input type="text" id="playlistname_input"/></div>
            <div class="pbc"><a id="save_queue_to_playlist" href="#"><i class="fa fa-floppy-o"></i><div> Save Queue</div></a></div>
          </div>
        </div>
        <div class="container">
          <h3 class="title clearfix">Playlists</h3>
          <div class="content">
            <ul class="playlists list"></ul>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div class="grid">
        <div class="row">
          <div class="col col-12">
            Now playing: <span id="tracktitle"></span>
          </div>
        </div>
        <div class="row">
          <div class="col col-12">
            <div class="pbc"><a href="#" id="prev"><i class="fa fa-backward"></i></a></div>
            <div class="pbc"><a href="#" id="play"><i class="fa fa-play"></i></a></div>
            <div class="pbc"><a href="#" id="stop"><i class="fa fa-stop"></i></a></div>
            <div class="pbc"><a href="#" id="next"><i class="fa fa-forward"></i></a></div>
            <div class="pbc"><a href="#" id="repeat"><i class="fa fa-repeat"></i></a></div>
            <div class="pbc"><a href="#" id="shuffle"><i class="fa fa-random"></i></a></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
