<html>
  <head>
    <title>Soundboard Webinterface</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="http://localhost:8080/socket.io/socket.io.js"></script>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/filelist.js"></script>
    <script>
      var socket;
      var tracks;
      var suffle = false;
      var repeat = false;
      $(document).ready(function onDocumentReady() {
        socket = io.connect('http://localhost:8080');
        socket.on('isPlaying', function onIsPlaying(data) {
          $('#play')[data["playing"] ? 'addClass' : 'removeClass']('playing');
          $('#play').find(".fa")[data["playing"] ? 'addClass' : 'removeClass']('fa-pause');
          $('#play').find(".fa")[!data["playing"] ? 'addClass' : 'removeClass']('fa-play');
        });
        socket.on('get_queue',function onGetCurrentQueue(data){
          //console.log(data);
          $('#shuffle').children()[data["shuffle"] ? 'addClass' : 'removeClass']('active');
          $('#repeat').children()[data["repeat"] ? 'addClass' : 'removeClass']('active');
          tracks = data["queue"];
          $('.queue').empty();
          tracks.forEach(function(track, index){
            var elem = $('<li></li>');
            elem.addClass('item');
            elem[(!!data["currentTrack"] && !!data["currentTrack"]["id"] && track["id"] == data["currentTrack"]["id"]) ? 'addClass' : 'removeClass']('current');
            elem.attr('data-index', index);
            elem.attr('data-id', track["id"]);
            var title = $('<div></div>');
            title.addClass('title');
            title.html(track["path"]);
            elem.append(title);
            elem.append(generate_controls());
            elem.append($('<div class="clearfix"></div>'));
            $('.queue').append(elem);
          });
          $('.queue').find('a').on('click', function() {
            var e = $(this);
            var a = e.attr('data-action');
            var i = e.closest('.item');
            var id = i.attr('data-id');
            var index = i.attr('data-index');
            //alert(a + '\n' + index + '\n' + id + '\n');
            if(a=="play"){
              onPlaySelectedTrack(id);
            } else if (a=="up") {
              onMoveTrack(id,parseInt(index)-1);
            } else if (a=="down") {
              onMoveTrack(id,parseInt(index)+1);
            } else if (a=="remove"){
              onRemoveTrack(id);
            } else {
              console.log("What do you want from me?");
            }
          });
          $('#tracktitle').text();
        });
        socket.on('poll', function onPoll() {
          socket.emit('isPlaying');
          socket.emit('get_queue');
        });
        socket.on('getFiles', function onGetFiles(data) {
          console.log("filelist");
          console.log(data);
          generate_filelist($($('.files li')[0]), data["files"]);
          $($('.files li')[0]).find("ul").each(function() {
            $(this).children().last().addClass("lastChild");
          });
          $('.tabcontrol .tab#filesystem .fm .files .collapse').each(function() {
            CollapsibleLists.applyTo(this);
          });
          $('.files li').find('a').on('click', function() {
            var e = $(this);
            var path = e.attr('data-path');
            $('#filesystem-path').val(path);
          });
        });
        function generate_filelist(parent, data, title) {
          ulclass = "";
          if (title === undefined) {
            title = "Files";
            ulclass = "collapse";
          }
          console.log(title);
          parent.empty();
          if (typeof data === "object") {
            parent.append($('<i>' + title + '</i>'));
            if (!isEmpty(data)) {
              var ul = $('<ul></ul>');
              if (ulclass != "") {
                ul.addClass(ulclass);
              }
              for (var k in data) {
                if (data.hasOwnProperty(k)) {
                    var childs = $('<li></li>');
                    generate_filelist(childs, data[k], k);
                    ul.append(childs);
                }
              }
              parent.append(ul);
            }
          } else {
            console.log(title + " => " + data);
            parent.append($('<a data-path="' + data + '" href="#">' + title + '</a>'));
          }
        }
        socket.on('get_playlist', function onGetPlaylist(data){
          console.log('playlists');
          console.log(data);
          $('.playlists').empty();
          if(data['playlists'].length==0){
            var elem = $('<li></li>');
            elem.addClass('item');
            elem.html('No Playlists');
            $('.playlists').append(elem);
          }
          else {
            var playlists = data['playlists'];
            console.log(playlists);
            playlists.forEach(function(playlistname){
              var elem = $('<li></li>');
              elem.addClass('item');
              elem.attr('data-name',playlistname);
              elem.html(playlistname);
              elem.on('click',function(){
                onLoadPlaylist($(this).attr('data-name'));
              });
              $('.playlists').append(elem);
            });
          }
        });
        function generate_controls() {
          var controls = $('<div></div>');
          controls.addClass('pbc');
          controls.append(generate_action('play', 'play'));
          controls.append(generate_action('up', 'chevron-up'));
          controls.append(generate_action('down', 'chevron-down'));
          controls.append(generate_action('remove', 'remove'));
          return controls;
        }
        function generate_action(name, icon) {
          return $('<a data-action="' + name + '"><i class="fa fa-' + icon + '"></i></a>');
        }
        function emitPlayPause() {
          if ($('#play').hasClass('playing')) {
            emitPause();
          } else {
            emitPlay();
          }
        }
        function emitPause() {
          socket.emit('pause');
          socket.emit('isPlaying');
        }
        function emitPlay() {
          socket.emit('play');
          socket.emit('isPlaying');
        }
        function emitNext(){
          socket.emit('next');
        }
        function emitPrev() {
          socket.emit('prev');
        }
        function onPlayTitle(){
          //console.log("send track");
          service = $('#serviceSelector').attr("data-service");
          path = $('#' + service + '-path').val();
          socket.emit("add_track", {"service": service, "path": path,'next': true});
        }
        function onAddToQueue() {
          service = $('#serviceSelector').attr("data-service");
          path = $('#' + service + '-path').val();
          socket.emit("add_track", {"service": service, "path": path,'next': false});
        }
        function onClearQueue() {
          socket.emit("clear_queue");
        }
        function onStop() {
          socket.emit("stop");
        }
        function onLoadPlaylist(name){
          socket.emit("playPlaylist", {'name': name, 'playing': true});
        }
        function onSavePlaylist(){
          if($('#playlistname_input').val() != ""){
              socket.emit("save_queue_to_playlist", {"playlistname": $('#playlistname_input').val()});
              socket.emit("get_playlist", {"name": undefined});
          }
          else {
            window.alert('You need to give the Playlist a name');
          }
        };
        function toggleShuffle(){
          socket.emit('toggleShuffle');
          socket.emit('get_queue');
        };
        function toggleRepeat(){
          socket.emit('toggleRepeat');
          socket.emit('get_queue');
        }
        function onPlaySelectedTrack(id){
          socket.emit('playtrack',{'id':id});
        }
        function onRemoveTrack(id){
          socket.emit("delete_track", {'id': id});
          socket.emit("get_queue");
        }
        function onMoveTrack(id, newpos){
          socket.emit("chpos_of_track",{'id':id,'newpos':newpos});
          socket.emit("get_queue");
        }
        $('#prev').on('click', emitPrev);
        $('#next').on('click', emitNext);

        $('#play').on('click', emitPlayPause);
        $('#play_track').on('click', onPlayTitle);
        $('#add_to_queue').on('click', onAddToQueue);
        $('#clear_queue').on('click', onClearQueue);
        $('#stop').on('click',onStop);
        $('#save_queue_to_playlist').on('click',onSavePlaylist);
        $('#repeat').on('click',toggleRepeat);
        $('#shuffle').on('click',toggleShuffle);
        socket.emit("isPlaying");
        socket.emit("get_queue");
        socket.emit("getFiles");
        socket.emit("get_playlist",{"name":undefined});

        $('.tabcontrol').each(function() {
          tabcontrol = $(this);
          tabcontrol.bind('redraw', function() {
            if (!!$(this).attr("data-tab")) {
              $(this).find(".tab").removeClass("active");
              $(this).find(".tab#" + $(this).attr("data-tab")).addClass("active");
            } else {
              tabs = $(this).find(".tab");
              if (tabs.length) {
                $(this).trigger("setTab", [ $(tabs[0]).attr("id") ]);
              }
            }
            initializeJS();
          });
          tabcontrol.bind('setTab', function(event, id) {
            tab = $(this).find(".tab#" + id);
            $(this).find('.wrapper .nav a').removeClass("active");
            $(this).find('.wrapper .nav a[data-id="' + id + '"]').addClass("active");
            if (tab.length) {
              $(this).attr("data-tab", id);
              $(this).attr("data-service", tab.attr("data-service"));
              $(this).trigger("redraw");
            }
          });
          var nav = tabcontrol.find(".wrapper .nav");
          if (nav.length) {
            nav = $(nav[0]);
            tabcontrol.find(".tab").each(function() {
              tab = $(this);
              id = tab.attr("id");
              link = $('<a href="#" data-id="' + id + '"></a>');
              link.html(tab.find(".title").html());
              link.bind("click", { tabcontrol: tabcontrol }, function(event) {
                event.data.tabcontrol.trigger("setTab", [ $(this).attr("data-id") ]);
              });
              item = $('<li></li>');
              item.append(link);
              nav.append(item);
            });
            tabcontrol.trigger("setTab", [ (!!tabcontrol.attr("data-tab")) ? tabcontrol.attr("data-tab") : $(tabcontrol.find(".tab")[0]).attr("id") ]);
          }
        });

        function initializeJS() {
          // Do nothing

        }

        function isEmpty(obj) {
          // null and undefined are "empty"
          if (obj == null) return true;
          // Assume if it has a length property with a non-zero value
          // that that property is correct.
          if (obj.length > 0)    return false;
          if (obj.length === 0)  return true;
          // Otherwise, does it have any properties of its own?
          // Note that this doesn't handle
          // toString and valueOf enumeration bugs in IE < 9
          for (var key in obj) {
            if (hasOwnProperty.call(obj, key)) return false;
          }
          return true;
        }
      });
    </script>
  </head>
  <body id="page">
    <div class="header">
      <h1>Soundboard Webinterface</h1>
    </div>
    <div class="content">
      <div id="serviceSelector" class="tabcontrol">
        <div class="wrapper">
          <ul class="nav"></ul>
          <div class="tabs">
            <div id="youtube" data-service="youtube" class="tab">
              <div class="title"><i class="fa fa-youtube-play"></i> YouTube</div>
              <div class="content">
                <div class="pbc"><input type="text" id="youtube-path"/></div>
              </div>
            </div>
            <div id="filesystem" data-service="filesystem" class="tab">
              <div class="title"><i class="fa fa-folder"></i> Filesystem</div>
              <div class="content">
                <div class="pbc"><input type="text" id="filesystem-path" readonly/></div>
                <div class="fm">
                  <ul class="files"><li></li></ul>
                </div>
              </div>
            </div>
            <div id="url" data-service="url" class="tab">
              <div class="title"><i class="fa fa-link"></i> URL</div>
              <div class="content">
                <div class="pbc"><input type="text" id="url-path"/></div>
              </div>
            </div>
          </div>
          <div class="append">
            <div class="pbc"><a class="pbc" id="play_track" href="#"><i class="fa fa-play"></i><div> Play this track</div></a></div>
            <div class="pbc"><a id="add_to_queue" href="#"><i class="fa fa-plus"></i><div> Add to Queue</div></a></div>
            <div class="pbc"><a id="clear_queue" href="#"><i class="fa fa-eject"></i><div> Clear Queue</div></a></div>
          </div>
        </div>
      </div>
      <div class="flow_container">
        <div class="list_container">
          <h3 class="list_title">Current Queue</h3>
            <div class="queue_inner_container">
              <ul class="queue list">
              </ul>
            </div>
            <div class="list_bottom">
              <div class="pbc"><input type="text" id="playlistname_input"/></div>
              <div class="pbc"><a id="save_queue_to_playlist" href="#"><i class="fa fa-floppy-o"></i><div> Save Queue</div></a></div>
            </div>
          </div>
          <div class="list_container">
            <h3 class="list_title">Playlists</h3>
            <ul class="playlists list"></ul>
          </div>
      </div>
      <div class="push"></div>
    </div>
    <div class="footer">
      <div class="grid">
        <div class="row">
          <div class="col col-12">
            Now playing: <span id="tracktitle"></span>
          </div>
        </div>
        <div class="row">
          <div class="col col-12">
            <div class="pbc"><a href="#" id="prev"><i class="fa fa-backward"></i></a></div>
            <div class="pbc"><a href="#" id="play"><i class="fa fa-play"></i></a></div>
            <div class="pbc"><a href="#" id="stop"><i class="fa fa-stop"></i></a></div>
            <div class="pbc"><a href="#" id="next"><i class="fa fa-forward"></i></a></div>
            <div class="pbc"><a href="#" id="repeat"><i class="fa fa-repeat"></i></a></div>
            <div class="pbc"><a href="#" id="shuffle"><i class="fa fa-random"></i></a></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
